<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Acción Preventiva - PEMEX</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <!-- PEMEX Theme -->
    <link href="{{ url_for('static', filename='css/pemex-theme.css') }}" rel="stylesheet" />
  </head>
  <body>
    <!-- Navegación -->
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('admin') }}">
          <i class="fas fa-industry me-2"></i>
          <strong>PEMEX</strong> <span class="text-light">Sistema de Acciones Preventivas</span>
        </a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="{{ url_for('admin') }}"><i class="fas fa-home me-1"></i> Inicio</a>
          <a class="nav-link" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt me-1"></i> Cerrar Sesión</a>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <!-- Header de la página -->
      <div class="page-header fade-in">
        <h1><i class="fas fa-plus-circle me-3"></i>Registro de Acción Preventiva</h1>
        <p>Complete todos los campos para registrar una nueva acción preventiva</p>
      </div>

      <!-- Formulario principal -->
      <div class="main-content fade-in">
        <form id="formAccion" enctype="multipart/form-data">
          <!-- Sección 1: Información General -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información General</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="folio" class="form-label">Folio <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="folio" name="folio" required />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="fecha_registro" class="form-label">Fecha de Registro <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="fecha_registro" name="fecha_registro" required />
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="region" class="form-label">Región <span class="text-danger">*</span></label>
                    <select class="form-select" id="region" name="region" required>
                      <option value="">Seleccione una región</option>
                      <option value="Norte">Norte</option>
                      <option value="Sur">Sur</option>
                      <option value="Centro">Centro</option>
                      <option value="Marina Noreste">Marina Noreste</option>
                      <option value="Marina Suroeste">Marina Suroeste</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="activo" class="form-label">Activo <span class="text-danger">*</span></label>
                    <select class="form-select" id="activo" name="activo" required>
                      <option value="">Seleccione un activo</option>
                      <option value="PEP">PEP</option>
                      <option value="TRI">TRI</option>
                      <option value="PMI">PMI</option>
                      <option value="PREF">PREF</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="instalacion" class="form-label">Instalación <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="instalacion" name="instalacion" required />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sección 2: Ubicación Geográfica -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Ubicación Geográfica</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="estado" class="form-label">Estado <span class="text-danger">*</span></label>
                    <select class="form-select" id="estado" name="estado" required>
                      <option value="">Seleccione un estado</option>
                      <option value="Campeche">Campeche</option>
                      <option value="Tabasco">Tabasco</option>
                      <option value="Veracruz">Veracruz</option>
                      <option value="Tamaulipas">Tamaulipas</option>
                      <option value="Chiapas">Chiapas</option>
                      <!-- Agregar más estados según necesidad -->
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="municipio" class="form-label">Municipio <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="municipio" name="municipio" required />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="localidad" class="form-label">Localidad <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="localidad" name="localidad" required />
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="coordenadas_x" class="form-label">Coordenadas X (UTM)</label>
                    <input type="number" step="0.000001" class="form-control" id="coordenadas_x" name="coordenadas_x" />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="coordenadas_y" class="form-label">Coordenadas Y (UTM)</label>
                    <input type="number" step="0.000001" class="form-control" id="coordenadas_y" name="coordenadas_y" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sección 3: Problemática Social -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-users me-2"></i>Problemática Social</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-12">
                  <div class="form-group">
                    <label for="tipo_problematica" class="form-label">Tipo de Problemática <span class="text-danger">*</span></label>
                    <select class="form-select" id="tipo_problematica" name="tipo_problematica" required>
                      <option value="">Seleccione el tipo de problemática</option>
                      <option value="Bloqueo de instalaciones">Bloqueo de instalaciones</option>
                      <option value="Interrupción de operaciones">Interrupción de operaciones</option>
                      <option value="Manifestaciones">Manifestaciones</option>
                      <option value="Negociaciones laborales">Negociaciones laborales</option>
                      <option value="Conflictos comunitarios">Conflictos comunitarios</option>
                      <option value="Demandas de empleo">Demandas de empleo</option>
                      <option value="Solicitudes de apoyo social">Solicitudes de apoyo social</option>
                      <option value="Otros">Otros</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-12">
                  <div class="form-group">
                    <label for="descripcion_problematica" class="form-label">Descripción Detallada de la Problemática <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="descripcion_problematica" name="descripcion_problematica" rows="4" required placeholder="Describa detalladamente la problemática social identificada..."></textarea>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="actor_social" class="form-label">Actor Social Principal <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="actor_social" name="actor_social" required placeholder="Ej: Sindicato, Comunidad, ONG, etc." />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="nivel_impacto" class="form-label">Nivel de Impacto <span class="text-danger">*</span></label>
                    <select class="form-select" id="nivel_impacto" name="nivel_impacto" required>
                      <option value="">Seleccione el nivel de impacto</option>
                      <option value="Alto">Alto</option>
                      <option value="Medio">Medio</option>
                      <option value="Bajo">Bajo</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sección 4: Acción Preventiva -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Acción Preventiva Propuesta</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-12">
                  <div class="form-group">
                    <label for="accion_preventiva" class="form-label">Descripción de la Acción Preventiva <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="accion_preventiva" name="accion_preventiva" rows="4" required placeholder="Describa la acción preventiva propuesta para abordar la problemática..."></textarea>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="fecha_inicio" class="form-label">Fecha de Inicio <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" required />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="fecha_fin" class="form-label">Fecha de Fin Estimada <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="fecha_fin" name="fecha_fin" required />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="presupuesto" class="form-label">Presupuesto Estimado (MXN)</label>
                    <input type="number" step="0.01" class="form-control" id="presupuesto" name="presupuesto" placeholder="0.00" />
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="responsable" class="form-label">Responsable de la Acción <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="responsable" name="responsable" required placeholder="Nombre del responsable" />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="area_responsable" class="form-label">Área Responsable <span class="text-danger">*</span></label>
                    <select class="form-select" id="area_responsable" name="area_responsable" required>
                      <option value="">Seleccione el área responsable</option>
                      <option value="Relaciones Institucionales">Relaciones Institucionales</option>
                      <option value="Seguridad Industrial">Seguridad Industrial</option>
                      <option value="Recursos Humanos">Recursos Humanos</option>
                      <option value="Operaciones">Operaciones</option>
                      <option value="Mantenimiento">Mantenimiento</option>
                      <option value="Comunicación Social">Comunicación Social</option>
                      <option value="Jurídico">Jurídico</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sección 5: Documentos Adjuntos -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-paperclip me-2"></i>Documentos de Respaldo</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="documento_1" class="form-label">Documento Principal</label>
                    <input type="file" class="form-control" id="documento_1" name="documento_1" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" />
                    <small class="text-muted">Formatos permitidos: PDF, DOC, DOCX, JPG, PNG</small>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="documento_2" class="form-label">Documento Adicional</label>
                    <input type="file" class="form-control" id="documento_2" name="documento_2" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" />
                    <small class="text-muted">Formatos permitidos: PDF, DOC, DOCX, JPG, PNG</small>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-12">
                  <div class="form-group">
                    <label for="observaciones" class="form-label">Observaciones Adicionales</label>
                    <textarea class="form-control" id="observaciones" name="observaciones" rows="3" placeholder="Observaciones, comentarios adicionales o información relevante..."></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones de acción -->
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" onclick="window.history.back()"><i class="fas fa-arrow-left me-2"></i>Cancelar</button>
            <div>
              <button type="button" class="btn btn-outline-primary me-2" onclick="guardarBorrador()"><i class="fas fa-save me-2"></i>Guardar Borrador</button>
              <button type="submit" class="btn btn-primary"><i class="fas fa-check me-2"></i>Registrar Acción</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript personalizado -->
    <script>
      // Establecer fecha actual por defecto
      document.getElementById('fecha_registro').value = new Date().toISOString().split('T')[0]
      
      // Validación de fechas
      document.getElementById('fecha_inicio').addEventListener('change', function () {
        const fechaInicio = new Date(this.value)
        const fechaFin = document.getElementById('fecha_fin')
      
        if (fechaFin.value) {
          const fechaFinValue = new Date(fechaFin.value)
          if (fechaFinValue <= fechaInicio) {
            alert('La fecha de fin debe ser posterior a la fecha de inicio')
            fechaFin.value = ''
          }
        }
      })
      
      document.getElementById('fecha_fin').addEventListener('change', function () {
        const fechaInicio = document.getElementById('fecha_inicio').value
        if (fechaInicio) {
          const fechaInicioValue = new Date(fechaInicio)
          const fechaFin = new Date(this.value)
      
          if (fechaFin <= fechaInicioValue) {
            alert('La fecha de fin debe ser posterior a la fecha de inicio')
            this.value = ''
          }
        }
      })
      
      // Envío del formulario
      document.getElementById('formAccion').addEventListener('submit', function (e) {
        e.preventDefault()
      
        const formData = new FormData(this)
      
        // Mostrar indicador de carga
        const submitBtn = this.querySelector('button[type="submit"]')
        const originalText = submitBtn.innerHTML
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...'
        submitBtn.disabled = true
      
        fetch('/api/acciones', {
          method: 'POST',
          body: formData
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert('Acción preventiva registrada exitosamente')
              window.location.href = '/admin'
            } else {
              alert('Error al registrar la acción: ' + data.message)
            }
          })
          .catch((error) => {
            console.error('Error:', error)
            alert('Error al enviar el formulario')
          })
          .finally(() => {
            submitBtn.innerHTML = originalText
            submitBtn.disabled = false
          })
      })
      
      // Función para guardar borrador
      function guardarBorrador() {
        const formData = new FormData(document.getElementById('formAccion'))
        formData.append('borrador', 'true')
      
        fetch('/api/acciones/borrador', {
          method: 'POST',
          body: formData
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert('Borrador guardado exitosamente')
            } else {
              alert('Error al guardar el borrador: ' + data.message)
            }
          })
          .catch((error) => {
            console.error('Error:', error)
            alert('Error al guardar el borrador')
          })
      }
      
      // Generar folio automático
      function generarFolio() {
        const fecha = new Date()
        const año = fecha.getFullYear()
        const mes = String(fecha.getMonth() + 1).padStart(2, '0')
        const dia = String(fecha.getDate()).padStart(2, '0')
        const hora = String(fecha.getHours()).padStart(2, '0')
        const minuto = String(fecha.getMinutes()).padStart(2, '0')
      
        return `AP-${año}${mes}${dia}-${hora}${minuto}`
      }
      
      // Auto-generar folio si está vacío
      document.addEventListener('DOMContentLoaded', function () {
        const folioInput = document.getElementById('folio')
        if (!folioInput.value) {
          folioInput.value = generarFolio()
        }
      })
    </script>
  </body>
</html>
